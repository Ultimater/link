<?php

$routes = [
    'about'                                => 'https://phalconphp.com/en/about',
    'blog'                                 => 'https://blog.phalconphp.com',
    'compose'                              => 'https://phalcon-compose.readme.io',
    'docs'                                 => 'https://docs.phalconphp.com',
    'donate'                               => 'https://patreon.com/phalcon',
    'download'                             => 'https://phalconphp.com/en/download',
    'download/linux'                       => 'https://packagecloud.io/phalcon/stable',
    'download/windows/latest/x86-70'       => 'https://my.pcloud.com/publink/show?code=XZILqUZa6DY8xPDzyRi1G0FDi7EPzCPHjSk',
    'download/windows/latest/x86-70-nts'   => 'https://my.pcloud.com/publink/show?code=XZALqUZdkFttUqyzjh1ype84N8jVXErLjHy',
    'download/windows/latest/x86-56'       => 'https://my.pcloud.com/publink/show?code=XZ6LqUZR1cEOK8hSnH1zb4BgCKVP7Sqinkk',
    'download/windows/latest/x86-56-nts'   => 'https://my.pcloud.com/publink/show?code=XZOLqUZY4lnm7Sm9pBc0k8R7L8ENRN0mmAk',
    'download/windows/latest/x86-55'       => 'https://my.pcloud.com/publink/show?code=XZ2LqUZogQBdpYILFhbdUcC5CrOJLwoHSxV',
    'download/windows/latest/x86-55-nts'   => 'https://my.pcloud.com/publink/show?code=XZxLqUZvv7ykXXSSHzu0JhhvVpcHmhrNNUV',
    'download/windows/latest/x64-70'       => 'https://my.pcloud.com/publink/show?code=XZyLqUZW5yBAUl6v0HzDEIHVoEnCHLs5RW7',
    'download/windows/latest/x64-70-nts'   => 'https://my.pcloud.com/publink/show?code=XZkLqUZJ9riyygqWEpRsnOQd7dr14SWWQc7',
    'download/windows/latest/x64-56'       => 'https://my.pcloud.com/publink/show?code=XZARqUZuO3mHnnKpd7P1enqdam9OkQvLlgV',
    'download/windows/latest/x64-56-nts'   => 'https://my.pcloud.com/publink/show?code=XZGRqUZvp7KJjT9Y7J5rQx9AjkWChOFhkLV',
    'download/windows/latest/x64-55'       => 'https://my.pcloud.com/publink/show?code=XZJRqUZjPlWFL0ti3zb3Woib7QgSbzHLWFk',
    'download/windows/latest/x64-55-nts'   => 'https://my.pcloud.com/publink/show?code=XZLRqUZx2xYlmEPn8ulildzyoFS1Lmsdbe7',
    'download/windows/previous/x86-56'     => 'https://my.pcloud.com/publink/show?code=XZghtdZPOBAVlsV0qVpOdbU96DzFR6VpQCV',
    'download/windows/previous/x86-56-nts' => 'https://my.pcloud.com/publink/show?code=XZ8htdZuGwqwqOmTsXhyWTmoMyK04T54VaX',
    'download/windows/previous/x86-55'     => 'https://my.pcloud.com/publink/show?code=XZchtdZthOQwMjvEMHKsVRuVicG5QfXHnUy',
    'download/windows/previous/x86-55-nts' => 'https://my.pcloud.com/publink/show?code=XZqhtdZMebhwXKVSOFVhWOIi5604b9IwVSk',
    'download/windows/previous/x64-56'     => 'https://my.pcloud.com/publink/show?code=XZBStdZJM2G393wghXcYGUsUutlNXvVMdQ7',
    'download/windows/previous/x64-56-nts' => 'https://my.pcloud.com/publink/show?code=XZbStdZrlH892ivo74apYhbcWE5MVwhnU70',
    'download/windows/previous/x64-55'     => 'https://my.pcloud.com/publink/show?code=XZMStdZvWO3lN83WMXNU7x0rs1aifbPhg8X',
    'download/windows/previous/x64-55-nts' => 'https://my.pcloud.com/publink/show?code=XZDStdZ7jWdFWfzp4VTDTYXTtNU1hLEakwy',
    'facebook'                             => 'https://www.facebook.com/Phalcon-Framework-134230726685897/',
    'fb'                                   => 'https://www.facebook.com/Phalcon-Framework-134230726685897/',
    'forum'                                => 'https://forum.phalconphp.com',
    'fund'                                 => 'https://opencollective.com/phalcon',
    'funding'                              => 'https://opencollective.com/phalcon',
    'g+'                                   => 'https://plus.google.com/u/0/b/102376109340560896457/+PhalconPHP',
    'gab'                                  => 'https://gab.ai/phalcon',
    'github'                               => 'https://github.com/phalcon/cphalcon',
    'github-docs'                          => 'https://github.com/phalcon/docs',
    'license'                              => 'https://license.phalconphp.com',
    'resources'                            => 'http://phalconist.com',
    'sample-apps'                          => 'https://docs.phalconphp.com/en/latest/reference/tutorial.html#sample-applications',
    'slack'                                => 'https://phalconchats.slack.com/messages/general/',
    'so'                                   => 'https://stackoverflow.com/questions/tagged/phalcon',
    'store'                                => 'https://store.phalconphp.com',
    'support_us'                           => 'https://patreon.com/phalcon',
    't'                                    => 'https://twitter.com/phalconphp',
    'team'                                 => 'https://phalconphp.com/en/team',
    'team/andres'                          => 'https://github.com/andresgutierrez',
    'team/eduar'                           => 'https://github.com/carvajaldiazeduar',
    'team/nikolay'                         => 'https://github.com/xboston',
    'team/nikos'                           => 'https://github.com/niden',
    'team/serghei'                         => 'https://github.com/sergeyklay',
    'tutorial'                             => 'https://docs.phalconphp.com/en/latest/reference/tutorial.html',
    'twitter'                              => 'https://twitter.com/phalconphp',
    'default'                              => 'https://phalconphp.com',
];

$app = new \Phalcon\Mvc\Micro();

$getBase      = function () use ($app, $routes) {
    $output   = <<<EOF
<!DOCTYPE html>
<html lang="en">
<title>Phalcon Link</title>
<head>
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
          crossorigin="anonymous">
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Stub</th>
                    <th>URL</th>
                </tr>
                </thead>
                <tbody>
                    %s
                </tbody>
            </thead>
            </table>
        </div>
    </div>
</body>
</html>
EOF;
    $template = '<tr><td><a href="https://phalcon.link/%s">%s</a></td><td><a href="%s">%s</a></td></tr>' . PHP_EOL;
    $links    = sprintf(
        $template,
        'www',
        'Website',
        $routes['default'],
        $routes['default']
    );
    ksort($routes);
    foreach ($routes as $key => $url) {
        if ('default' !== $key) {
            $links .= sprintf($template, $key, $key, $url, $url);
        }
    }

    $output = sprintf($output, $links);
    $app->response->setContent($output);

    return $app->response->send();
};
$getRedirect  = function ($url, $platform, $category, $version) use ($app, $routes) {
    $url = strtolower($url);
    switch ($url) {
        case 'download':
            switch ($platform) {
                case 'linux':
                    $url = 'download/linux';
                    break;
                case 'windows':
                    $url = sprintf(
                        'download/%s/%s/%s',
                        $platform,
                        $category,
                        $version
                    );
                    break;
            }
            break;
        case 'team':
            $url = sprintf('team/%s', $platform);
            break;
    }

    if (true === array_key_exists($url, $routes)) {
        $redirect = $routes[$url];
    } else {
        $redirect = $routes['default'];
    }

    return $app->response->redirect($redirect, true);
};
$routeProcess = function ($url, $platform, $category, $version) use ($app, $routes, $getBase, $getRedirect) {
    if (true === empty($url)) {
        return $getBase();
    } else {
        return $getRedirect($url, $platform, $category, $version);
    }
};

$app->notFound(
    function () use ($app) {
        $app->response->setStatusCode(404, "Not Found");
        $app->response->sendHeaders();

        echo "This link does not exist";
    }
);
$app->get('/{url}', $routeProcess);
$app->get('/{url}/{platform}', $routeProcess);
$app->get('/{url}/{platform}/{category}', $routeProcess);
$app->get('/{url}/{platform}/{category}/{version}', $routeProcess);

$app->handle();
